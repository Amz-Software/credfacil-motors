{% extends 'base.html' %}
{% load static iam_tags l10n %}

{% block extra_head %}
  {{ form_analise_credito.media.css }}
  <style>
    .card-footer {
      position: sticky;
      bottom: 0;
      background: white;
      padding: 1rem;
      border-top: 1px solid #ddd;
      z-index: 10;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    
    /* Progress Bar */
    .progress-container {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      border: 1px solid #e9ecef;
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .progress-step:last-child {
      margin-bottom: 0;
    }
    
    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e9ecef;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
      transition: all 0.3s ease;
    }
    
    .step-number.active {
      background: #007bff;
      color: white;
    }
    
    .step-number.completed {
      background: #28a745;
      color: white;
    }
    
    .step-text {
      flex: 1;
      font-weight: 500;
    }
    
    .step-text.completed {
      color: #28a745;
    }
    
    /* Form Improvements */
    .form-section {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .form-section h5 {
      color: #495057;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
    }
    
    .form-control:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .form-control.is-valid {
      border-color: #28a745;
      box-shadow: 0 0 0 0.2rem rgba(40,167,69,0.25);
    }
    
    .form-control.is-invalid {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.2rem rgba(220,53,69,0.25);
    }
    
    .validation-feedback {
      font-size: 0.875rem;
      margin-top: 5px;
    }
    
    .validation-feedback.valid-feedback {
      color: #28a745;
    }
    
    .validation-feedback.invalid-feedback {
      color: #dc3545;
    }
    
    /* Product Cards */
    .product-info-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .info-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .info-card:hover {
      transform: translateY(-2px);
    }
    
    .info-card.entrada {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .info-card.total {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .info-card.parcelas {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .info-card-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .info-card-value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    /* Tabs Enhancement */
    .nav-tabs .nav-link {
      border: none;
      color: #6c757d;
      font-weight: 500;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
      color: #007bff;
      background: #f8f9fa;
    }
    
    .nav-tabs .nav-link.active {
      color: #007bff;
      background: white;
      border-bottom: 3px solid #007bff;
    }
    
    /* Alert Improvements */
    .alert {
      border-radius: 8px;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .alert-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .alert-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    
    /* IMEI Section */
    .imei-section {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #007bff;
    }
    
    .imei-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .imei-status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .imei-status.warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    
    /* Tooltip */
    .tooltip-icon {
      color: #6c757d;
      cursor: help;
      margin-left: 5px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .product-info-cards {
        grid-template-columns: 1fr;
      }
      
      .progress-step {
        flex-direction: column;
        text-align: center;
      }
      
      .step-number {
        margin-right: 0;
        margin-bottom: 10px;
      }
    }
  </style>
{% endblock extra_head %}

{% block title %}
  {% if cliente.pk %}Editar An√°lise de Cr√©dito{% else %}Criar An√°lise de Cr√©dito{% endif %}
{% endblock title %}

{% block content %}
<div class="container-xxl mt-4">
  <div class="card">
    <!-- Header -->
    <div class="card-header d-flex align-items-center p-3">
      <h4 class="mb-0">
        <i class="bx bx-user-plus me-2"></i>
        {% if cliente.pk %}Editar An√°lise de Cr√©dito{% else %}Criar An√°lise de Cr√©dito{% endif %}
      </h4>

      {# badge de an√°lise de cr√©dito continua igual‚Ä¶ #}
      {% if cliente.pk and cliente.analise_credito %}
        {% with analise=cliente.analise_credito %}
          <span class="badge fs-5 p-2
            {% if analise.status == 'A' %}bg-success
            {% elif analise.status == 'R' %}bg-danger
            {% elif analise.status == 'C' %}bg-secondary
            {% else %}bg-warning text-dark{% endif %} ms-3">
            {{ analise.get_status_display }}
          </span>
        {% endwith %}
      {% endif %}

      {# dropdown de Status App #}
      {% if cliente.pk and user|has_perm:"vendas.change_cliente" %}
      <form method="post"
            action="{% url 'vendas:cliente_status_app_update' cliente.pk %}"
            class="ms-auto d-flex align-items-center">
        {% csrf_token %}
        <div class="input-group input-group-sm w-auto">
          <label class="input-group-text" for="statusAppSelect{{ cliente.pk }}">
            App
          </label>
          <select name="status_app"
                  id="statusAppSelect{{ cliente.pk }}"
                  class="form-select"
                  onchange="this.form.submit()">
            <option value="" disabled>‚Äî</option>
            {% for code,label in status_app_choices %}
              <option value="{{ code }}"
                {% if analise_credito.status_aplicativo == code %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>
      </form>

      {% else %}
        {# s√≥ exibe badge se sem permiss√£o #}
        <span class="badge fs-6 p-2 ms-auto
          {% if cliente.analise_credito.status_aplicativo == 'P' %}bg-warning text-dark
          {% elif cliente.analise_credito.status_aplicativo == 'C' %}bg-info text-white
          {% else %}bg-success{% endif %}">
          {{ cliente.get_status_aplicativo_display }}
        </span>
      {% endif %}
    </div>

    <form method="post" enctype="multipart/form-data" id="clienteForm">
      {% csrf_token %}
      <div class="card-body">
        
        <!-- Progress Bar -->
        <div class="progress-container">
          <h6 class="mb-3"><i class="bx bx-list-check me-2"></i>Progresso do Preenchimento</h6>
          <div class="progress-step" id="step-dados">
            <div class="step-number" id="step-dados-number">1</div>
            <div class="step-text" id="step-dados-text">Dados do Cliente</div>
          </div>
          <div class="progress-step" id="step-comprovantes">
            <div class="step-number" id="step-comprovantes-number">2</div>
            <div class="step-text" id="step-comprovantes-text">Comprovantes</div>
          </div>
          <div class="progress-step" id="step-produto">
            <div class="step-number" id="step-produto-number">3</div>
            <div class="step-text" id="step-produto-text">Produto e Condi√ß√µes</div>
          </div>
        </div>

        <!-- Nav tabs -->
        <ul class="nav nav-tabs mb-3" id="clienteTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dados" type="button">
              <i class="bx bx-user me-1"></i>Dados
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-comprovantes" type="button">
              <i class="bx bx-file me-1"></i>Comprovantes
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-analise" type="button">
              <i class="bx bx-package me-1"></i>Produto
            </button>
          </li>
        </ul>

        <div class="tab-content">
          <!-- ABA DADOS CLIENTE -->
          <div class="tab-pane fade show active" id="tab-dados" role="tabpanel">
            <div class="form-section">
              <h5><i class="bx bx-user me-2"></i>Dados do Cliente</h5>
              
              {% if form_cliente.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form_cliente.non_field_errors }}
                </div>
              {% endif %}
              
              <div class="row">
                {% for field in form_cliente %}
                  {% if field.label == 'Cliente cred facil' %}
                    <div class="col-md-12">
                      <div class="form-check form-switch mt-3">
                        {{ field }} 
                        <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
                        {% if field.errors %}
                          <div class="text-danger small">{{ field.errors|striptags }}</div>
                        {% endif %}
                      </div>
                    </div>
                  {% elif field.label == 'Nascimento' %}
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                          {{ field.label }}
                          {% if field.field.required %}
                            <span class="text-danger">*</span>
                          {% endif %}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                          <div class="text-danger small">{{ field.errors|striptags }}</div>
                        {% endif %}
                      </div>
                    </div>
                  {% else %}
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="{{ field.id_for_label }}" class="form-label">
                          {{ field.label }}
                          {% if field.field.required %}
                            <span class="text-danger">*</span>
                          {% endif %}
                        </label>
                        {{ field }}
                        {% if field.errors %}
                          <div class="text-danger small">{{ field.errors|striptags }}</div>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>

            <!-- Informa√ß√µes Pessoais -->
            <div class="form-section">
              <h5><i class="bx bx-info-circle me-2"></i>Informa√ß√µes Pessoais</h5>
              
              {% if form_informacao.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form_informacao.non_field_errors }}
                </div>
              {% endif %}
              
              <div class="row">
                {% for field in form_informacao %}
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ field.id_for_label }}" class="form-label">
                        {{ field.label }}
                        {% if field.field.required %}
                          <span class="text-danger">*</span>
                        {% endif %}
                      </label>
                      {{ field }}
                      {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>

            <!-- Contato Adicional -->
            <div class="form-section">
              <h5><i class="bx bx-phone me-2"></i>Contato Adicional</h5>
              
              {% if form_adicional.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form_adicional.non_field_errors }}
                </div>
              {% endif %}
              
              <div class="row">
                {% for field in form_adicional %}
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ field.id_for_label }}" class="form-label">
                        {{ field.label }}
                        {% if field.field.required %}
                          <span class="text-danger">*</span>
                        {% endif %}
                      </label>
                      {{ field }}
                      {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- ABA COMPROVANTES -->
          <div class="tab-pane fade" id="tab-comprovantes" role="tabpanel">
            <div class="form-section">
              <h5><i class="bx bx-file me-2"></i>Comprovantes</h5>
              
              {% if form_comprovantes.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form_comprovantes.non_field_errors }}
                </div>
              {% endif %}
              
              <div class="row">
                {% for field in form_comprovantes %}
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ field.id_for_label }}" class="form-label">
                        {{ field.label }}
                        {% if field.field.required %}
                          <span class="text-danger">*</span>
                        {% endif %}
                        <i class="bx bx-help-circle tooltip-icon" data-bs-toggle="tooltip" title="Clique para selecionar um arquivo"></i>
                      </label>
                      
                      {% if field.value and field.value.url %}
                        <div class="mb-2">
                          <a href="{{ field.value.url }}" target="_blank" class="d-block mb-2">
                            <img src="{{ field.value.url }}" class="img-thumbnail" style="max-height:100px;">
                          </a>
                          <small class="text-muted">Escolha um novo arquivo se quiser substituir.</small>
                        </div>
                      {% endif %}
                      
                      {{ field }}
                      {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- ABA AN√ÅLISE DE CR√âDITO -->
          <div class="tab-pane fade" id="tab-analise" role="tabpanel">
            <div class="form-section">
              <h5>
                <i class="bx bx-package me-2"></i>Produto e Condi√ß√µes
                {% if user|has_group:"ANALISTA" and not cliente.analise_credito.venda %}
                  <i class="bi bi-pencil-square text-primary" title="Analista: Voc√™ pode editar todos os campos antes da venda ser gerada"></i>
                {% elif user|has_perm:"vendas.can_edit_finished_sale" and cliente.analise_credito.venda %}
                  <i class="bi bi-pencil-square text-warning" title="Voc√™ pode editar esta solicita√ß√£o mesmo ap√≥s a venda ser gerada"></i>
                {% endif %}
              </h5>
              
              {% if form_analise_credito.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form_analise_credito.non_field_errors }}
                </div>
              {% endif %}
              
              {% if user|has_group:"ANALISTA" and not cliente.analise_credito.venda %}
                <div class="alert alert-info">
                  <i class="bi bi-info-circle me-2"></i>
                  <strong>Analista:</strong> Voc√™ pode editar produto, parcelas, data de vencimento e IMEI antes da venda ser gerada.
                </div>
              {% elif user|has_perm:"vendas.can_edit_finished_sale" and cliente.analise_credito.venda %}
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>Aten√ß√£o:</strong> Esta solicita√ß√£o j√° possui venda gerada. Apenas usu√°rios com permiss√£o espec√≠fica podem edit√°-la.
                </div>
              {% endif %}
              
              {# Se√ß√£o de IMEI #}
              {% if cliente.analise_credito %}
              <div class="imei-section">
                <h6 class="mb-3"><i class="bx bx-mobile me-2"></i>Informa√ß√µes do IMEI</h6>
                
                {% if cliente.analise_credito.imei %}
                  <div class="imei-status success">
                    <div>
                      <i class="bi bi-check-circle me-2"></i>
                      <strong>IMEI informado:</strong> {{ cliente.analise_credito.imei.imei }}
                    </div>
                    {% if user|has_perm:"vendas.change_analisecreditocliente" %}
                    <a href="{% url 'vendas:informar_imei_analise' cliente.analise_credito.pk %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-pencil"></i> Alterar
                    </a>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="imei-status warning">
                    <div>
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <strong>IMEI n√£o informado.</strong> 
                    </div>
                    {% if user|has_perm:"vendas.change_analisecreditocliente" %}
                    <a href="{% url 'vendas:informar_imei_analise' cliente.analise_credito.pk %}" class="btn btn-sm btn-primary">
                      <i class="bi bi-plus-circle"></i> Informar IMEI
                    </a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
              {% endif %}
              
              <div class="row">
                {% for field in form_analise_credito %}
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ field.id_for_label }}" class="form-label">
                        {{ field.label }}
                        {% if field.field.required %}
                          <span class="text-danger">*</span>
                        {% endif %}
                        {% if field.label == 'Produto' %}
                          <i class="bx bx-help-circle tooltip-icon" data-bs-toggle="tooltip" title="Selecione o produto desejado para ver os valores automaticamente"></i>
                        {% elif field.label == 'N√∫mero de parcelas' %}
                          <i class="bx bx-help-circle tooltip-icon" data-bs-toggle="tooltip" title="Escolha o n√∫mero de parcelas para calcular o valor total"></i>
                        {% elif field.label == 'Data de pagamento' %}
                          <i class="bx bx-help-circle tooltip-icon" data-bs-toggle="tooltip" title="Escolha o dia do m√™s para o vencimento das parcelas"></i>
                        {% endif %}
                      </label>
                      {{ field }}
                      {% if field.errors %}
                        <div class="text-danger small">{{ field.errors|striptags }}</div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
                
                <div class="col-md-12">
                  <div class="form-group">
                    <label class="form-label">Previs√£o dos vencimentos</label>
                    <div id="vencimento-previsao-analise" class="form-text text-primary"></div>
                  </div>
                </div>
              </div>
              
              <!-- Product Info Cards -->
              <div class="product-info-cards" id="parcelas-info">
                <div class="info-card entrada">
                  <div class="info-card-label">Entrada</div>
                  <div class="info-card-value" id="info-entrada">‚Äî</div>
                </div>
                <div class="info-card total">
                  <div class="info-card-label">Total</div>
                  <div class="info-card-value" id="info-total">‚Äî</div>
                </div>
                <div class="info-card parcelas">
                  <div class="info-card-label">Parcelas</div>
                  <div class="info-card-value" id="info-parcela">‚Äî</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER FIXO COM A√á√ïES -->
      <div class="card-footer d-flex justify-content-between align-items-center">
        {# a√ß√µes de an√°lise, agrupadas e √† esquerda #}
        <div>
          {% if cliente.pk and cliente.analise_credito %}
            <div class="btn-group" role="group" aria-label="An√°lise de Cr√©dito">
              <a href="{% url 'vendas:aprovar_analise' cliente.analise_credito.id %}"
                 class="btn btn-success">
                <i class="bx bx-check me-1"></i> Aprovar
              </a>
              <a href="{% url 'vendas:reprovar_analise' cliente.analise_credito.id %}"
                 class="btn btn-danger">
                <i class="bx bx-x me-1"></i> Reprovar
              </a>
              <a href="{% url 'vendas:cancelar_analise' cliente.analise_credito.id %}"
                 class="btn btn-outline-secondary">
                <i class="bx bx-reset me-1"></i> Cancelar
              </a>
            </div>
          {% endif %}
        </div>
      
        {# a√ß√µes de salvar/voltar, √† direita #}
        <div>
          {% if user|has_perm:'vendas.change_cliente' %}
            <button type="submit" class="btn btn-primary me-2" id="submitBtn">
              <i class="bx bx-save me-1"></i> Salvar
            </button>
          {% endif %}
          <a href="{% url 'vendas:cliente_list' %}" class="btn btn-secondary">
            <i class="bx bx-arrow-back me-1"></i> Voltar
          </a>
        </div>
      </div>
      
    </form>
  </div>
</div>
{% endblock content %}

{% block extra_scripts %}
  {{ form_analise_credito.media.js }}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
  <script>
    $('.tel').mask('00 00000-0000');
    $('.cpf').mask('000.000.000-00');
    $('.rg').mask('00000000');
    $('.cep').mask('00000000');
  </script>
  <script>
    $(function(){
      // Inicializar tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      });

      // Progress tracking
      function updateProgress() {
        let completedSteps = 0;
        let totalSteps = 3;
        
        // Check dados step
        let dadosComplete = checkDadosComplete();
        console.log('Dados complete:', dadosComplete);
        if (dadosComplete) {
          $('#step-dados-number').removeClass('active').addClass('completed');
          $('#step-dados-text').addClass('completed');
          completedSteps++;
        } else {
          $('#step-dados-number').removeClass('completed').addClass('active');
          $('#step-dados-text').removeClass('completed');
        }
        
        // Check comprovantes step
        let comprovantesComplete = checkComprovantesComplete();
        if (comprovantesComplete) {
          $('#step-comprovantes-number').removeClass('active').addClass('completed');
          $('#step-comprovantes-text').addClass('completed');
          completedSteps++;
        } else {
          $('#step-comprovantes-number').removeClass('completed').addClass('active');
          $('#step-comprovantes-text').removeClass('completed');
        }
        
        // Check produto step
        let produtoComplete = checkProdutoComplete();
        if (produtoComplete) {
          $('#step-produto-number').removeClass('active').addClass('completed');
          $('#step-produto-text').addClass('completed');
          completedSteps++;
        } else {
          $('#step-produto-number').removeClass('completed').addClass('active');
          $('#step-produto-text').removeClass('completed');
        }
        
        // Update submit button
        if (completedSteps === totalSteps) {
          $('#submitBtn').removeClass('btn-primary').addClass('btn-success');
          $('#submitBtn').html('<i class="bx bx-check me-1"></i> Formul√°rio Completo - Salvar');
        } else {
          $('#submitBtn').removeClass('btn-success').addClass('btn-primary');
          $('#submitBtn').html('<i class="bx bx-save me-1"></i> Salvar');
        }
      }
      
      function checkDadosComplete() {
        let requiredFields = [
          '#id_nome',
          '#id_cpf',
          '#id_nascimento',
          '#id_telefone',
          '#id_email',
          '#id_rg',
          '#id_cep'
        ];
        
        console.log('=== DEBUG CHECK DADOS COMPLETE ===');
        requiredFields.forEach(field => {
          console.log('Field exists:', field, $(field).length > 0);
          if ($(field).length > 0) {
            console.log('Field value:', field, $(field).val());
            console.log('Field type:', field, $(field).attr('type'));
          }
        });
        
        let complete = true;
        console.log('Starting validation with complete = true');
        requiredFields.forEach(field => {
          let value = $(field).val();
          console.log('Checking field:', field, 'Value:', value, 'Length:', value ? value.length : 0);
          if (!value || value.trim() === '') {
            console.log('‚ùå Field empty:', field, '- Setting complete = false');
            complete = false;
            return false;
          }
          console.log('‚úÖ Field OK:', field);
          
          if (field === '#id_email') {
            // Email validation for completion check
            console.log('Validating email:', value);
            if (!value.includes('@')) {
              console.log('‚ùå Email validation failed: no @ - Setting complete = false');
              complete = false;
              return false;
            } else {
              const parts = value.split('@');
              console.log('Email parts:', parts);
              if (parts.length !== 2 || parts[0].length === 0 || parts[1].length === 0) {
                console.log('‚ùå Email validation failed: invalid parts - Setting complete = false');
                complete = false;
                return false;
              } else if (!/[a-zA-Z]/.test(parts[0]) || !/[a-zA-Z]/.test(parts[1])) {
                console.log('‚ùå Email validation failed: no letters - Setting complete = false');
                complete = false;
                return false;
              }
            }
            console.log('‚úÖ Email validation passed');
          }
          
          if (field === '#id_telefone') {
            // Phone validation - check if it has between 10 and 11 digits
            console.log('Validating phone:', value);
            const digitsOnly = value.replace(/\D/g, '');
            console.log('Phone digits only:', digitsOnly, 'Length:', digitsOnly.length);
            if (digitsOnly.length < 10 || digitsOnly.length > 11) {
              console.log('‚ùå Phone validation failed: must have between 10 and 11 digits - Setting complete = false');
              complete = false;
              return false;
            }
            console.log('‚úÖ Phone validation passed');
          }
          
          if (field === '#id_rg') {
            // RG validation - check if it has between 7 and 12 digits
            console.log('Validating RG:', value);
            const digitsOnly = value.replace(/\D/g, '');
            console.log('RG digits only:', digitsOnly, 'Length:', digitsOnly.length);
            if (digitsOnly.length < 7 || digitsOnly.length > 12) {
              console.log('‚ùå RG validation failed: must have between 7 and 12 digits - Setting complete = false');
              complete = false;
              return false;
            }
            console.log('‚úÖ RG validation passed');
          }
          
          if (field === '#id_nascimento') {
            // Age validation - check if person is at least 18 years old
            console.log('Validating birth date:', value);
            if (value) {
              const birthDate = new Date(value);
              const today = new Date();
              const age = today.getFullYear() - birthDate.getFullYear();
              const monthDiff = today.getMonth() - birthDate.getMonth();
              
              // Adjust age if birthday hasn't occurred this year
              if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
              }
              
              console.log('Calculated age:', age);
              if (age < 18) {
                console.log('‚ùå Age validation failed: must be at least 18 years old - Setting complete = false');
                complete = false;
                return false;
              }
              console.log('‚úÖ Age validation passed');
            }
          }
          
          if (field === '#id_cep') {
            // CEP validation - check if it has exactly 8 digits
            console.log('Validating CEP:', value);
            const digitsOnly = value.replace(/\D/g, '');
            console.log('CEP digits only:', digitsOnly, 'Length:', digitsOnly.length);
            if (digitsOnly.length !== 8) {
              console.log('‚ùå CEP validation failed: must have exactly 8 digits - Setting complete = false');
              complete = false;
              return false;
            }
            console.log('‚úÖ CEP validation passed');
          }
        });
        
        console.log('üéØ Final result - complete =', complete);
        
        // Additional validation for duplicate phones
        if (complete) {
          const telefone = $('#id_telefone').val();
          const telefone_adicional = $('#id_telefone_adicional').val();
          
          if (telefone && telefone_adicional && telefone === telefone_adicional) {
            console.log('‚ùå Duplicate phone validation failed - Setting complete = false');
            complete = false;
          }
        }
        
        return complete;
      }
      
      function checkComprovantesComplete() {
        let requiredFields = [
          '#id_documento_identificacao_frente',
          '#id_documento_identificacao_verso',
          '#id_comprovante_residencia',
          '#id_foto_cliente'
        ];
        
        let complete = true;
        requiredFields.forEach(field => {
          let value = $(field).val();
          if (!value || value.trim() === '') {
            complete = false;
            return false;
          }
        });
        
        return complete;
      }
      
      function checkProdutoComplete() {
        let requiredFields = [
          '#id_produto',
          '#id_numero_parcelas',
          '#id_data_pagamento',
          '#id_observacao'
        ];
        
        let complete = true;
        requiredFields.forEach(field => {
          let value = $(field).val();
          if (!value || value.trim() === '') {
            complete = false;
            return false;
          }
        });
        
        return complete;
      }
      
      // Real-time validation
      function validateField(field) {
        let value = $(field).val();
        let fieldId = $(field).attr('id');
        let isValid = true;
        let message = 'Campo preenchido corretamente';
        
        // Check if field is empty
        if (!value || value.trim() === '') {
          isValid = false;
          message = 'Este campo √© obrigat√≥rio';
        } else {
          // Specific validations
          if (fieldId === 'id_cpf') {
            // CPF validation (basic)
            const cpfRegex = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
            if (!cpfRegex.test(value)) {
              isValid = false;
              message = 'Digite um CPF v√°lido (000.000.000-00)';
            }
          } else if (fieldId === 'id_telefone') {
            // Phone validation - check if it has between 10 and 11 digits
            const digitsOnly = value.replace(/\D/g, '');
            if (digitsOnly.length < 10 || digitsOnly.length > 11) {
              isValid = false;
              message = 'Telefone deve ter entre 10 e 11 d√≠gitos';
            }
          } else if (fieldId === 'id_rg') {
            // RG validation - check if it has between 7 and 12 digits
            const digitsOnly = value.replace(/\D/g, '');
            if (digitsOnly.length < 7 || digitsOnly.length > 12) {
              isValid = false;
              message = 'RG deve ter entre 7 e 12 d√≠gitos';
            }
          } else if (fieldId === 'id_nascimento') {
            // Age validation - check if person is at least 18 years old
            if (value) {
              const birthDate = new Date(value);
              const today = new Date();
              const age = today.getFullYear() - birthDate.getFullYear();
              const monthDiff = today.getMonth() - birthDate.getMonth();
              
              // Adjust age if birthday hasn't occurred this year
              if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
              }
              
              if (age < 18) {
                isValid = false;
                message = 'Cliente deve ter pelo menos 18 anos';
              }
            }
          } else if (fieldId === 'id_cep') {
            // CEP validation - check if it has exactly 8 digits
            const digitsOnly = value.replace(/\D/g, '');
            if (digitsOnly.length !== 8) {
              isValid = false;
              message = 'CEP deve ter exatamente 8 d√≠gitos';
            }
          }
        }
        
        if (isValid) {
          $(field).removeClass('is-invalid').addClass('is-valid');
          $(field).siblings('.validation-feedback').removeClass('invalid-feedback').addClass('valid-feedback').text(message);
        } else {
          $(field).removeClass('is-valid').addClass('is-invalid');
          $(field).siblings('.validation-feedback').removeClass('valid-feedback').addClass('invalid-feedback').text(message);
        }
        
        updateProgress();
      }
      
      // Add validation feedback elements
      $('input[required], select[required], textarea[required]').each(function() {
        if (!$(this).siblings('.validation-feedback').length) {
          $(this).after('<div class="validation-feedback"></div>');
        }
      });
      
      // Debug: Check if email field exists
      console.log('Email field found:', $('#id_email').length);
      console.log('Email field ID:', $('#id_email').attr('id'));
      console.log('Email field required:', $('#id_email').prop('required'));
      
      // Add validation feedback for email field specifically
      if ($('#id_email').length && !$('#id_email').siblings('.validation-feedback').length) {
        $('#id_email').after('<div class="validation-feedback"></div>');
      }
      
      // Bind validation events
      $('input, select, textarea').on('blur change', function() {
        if ($(this).prop('required')) {
          validateField(this);
        }
      });
      
      // Special validation for email field
      $('#id_email').on('blur change', function() {
        validateField(this);
      });
      
      // Validation for duplicate phones
      function validateDuplicatePhones() {
        const telefone = $('#id_telefone').val();
        const telefone_adicional = $('#id_telefone_adicional').val();
        
        if (telefone && telefone_adicional && telefone === telefone_adicional) {
          $('#id_telefone_adicional').removeClass('is-valid').addClass('is-invalid');
          $('#id_telefone_adicional').siblings('.validation-feedback').removeClass('valid-feedback').addClass('invalid-feedback').text('Telefone adicional n√£o pode ser igual ao telefone principal');
          return false;
        } else if (telefone_adicional) {
          $('#id_telefone_adicional').removeClass('is-invalid').addClass('is-valid');
          $('#id_telefone_adicional').siblings('.validation-feedback').removeClass('invalid-feedback').addClass('valid-feedback').text('Telefone adicional v√°lido');
        }
        return true;
      }
      
      // Bind validation for duplicate phones
      $('#id_telefone, #id_telefone_adicional').on('blur change', function() {
        validateDuplicatePhones();
      });
      
      // Tab switching with progress update
      $('.nav-link').on('click', function() {
        setTimeout(updateProgress, 100);
      });
      
      // lista de produtos do contexto
      const produtos = JSON.parse('{{ produtos_json|escapejs }}');

      function formatBRL(v) {
        return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      function atualizaInfo() {
        const prodId = $('#id_produto').val();
        const np     = $('#id_numero_parcelas').val();

        // se n√£o houver produto selecionado, limpa tudo
        if (!prodId) {
          $('#info-entrada, #info-total, #info-parcela').text('‚Äî');
          return;
        }

        // busca dados do produto
        const p = produtos.find(x => x.id == prodId) || {};
        const entrada = p.entrada  || 0;
        const valor4  = p.valor4   || 0;
        const valor6  = p.valor6   || 0;
        const valor8  = p.valor8   || 0;

        // escolhe total conforme parcelas
        const total = { '4': valor4, '6': valor6, '8': valor8 }[np] || 0;
        const parcela = (np && total)
          ? total / parseInt(np, 10)
          : 0;

        // preenche os cards
        $('#info-entrada').text(formatBRL(entrada));
        $('#info-total')  .text(formatBRL(total));

        const textoParcela = np
          ? `${np}√ó de ${formatBRL(parcela)}`
          : '‚Äî';
        $('#info-parcela').text(textoParcela);
        
        // Update progress after product selection
        updateProgress();
      }

      // dispara ao mudar produto (Select2) ou n√∫mero de parcelas
      $('#id_produto')
        .on('change select2:select', atualizaInfo);
      $('#id_numero_parcelas')
        .on('change', atualizaInfo);

      // inicializa ao carregar a p√°gina
      atualizaInfo();
      updateProgress();
      
      // Form submission enhancement - simplified
      $('#clienteForm').on('submit', function(e) {
        // Allow form submission without blocking
        // Just show a warning if there are validation errors
        let incompleteSteps = [];
        
        if (!checkDadosComplete()) {
          incompleteSteps.push('Dados do Cliente');
        }
        if (!checkComprovantesComplete()) {
          incompleteSteps.push('Comprovantes');
        }
        if (!checkProdutoComplete()) {
          incompleteSteps.push('Produto e Condi√ß√µes');
        }
        
        if (incompleteSteps.length > 0) {
          let message = 'Aten√ß√£o: As seguintes se√ß√µes podem estar incompletas:\n\n' + incompleteSteps.join('\n') + '\n\nDeseja continuar mesmo assim?';
          if (!confirm(message)) {
            e.preventDefault();
            // Switch to first incomplete tab
            if (!checkDadosComplete()) {
              $('[data-bs-target="#tab-dados"]').tab('show');
            } else if (!checkComprovantesComplete()) {
              $('[data-bs-target="#tab-comprovantes"]').tab('show');
            } else if (!checkProdutoComplete()) {
              $('[data-bs-target="#tab-analise"]').tab('show');
            }
          }
        }
      });
      
      // Auto-save indicator
      let autoSaveTimer;
      $('input, select, textarea').on('input change', function() {
        clearTimeout(autoSaveTimer);
        $('#submitBtn').html('<i class="bx bx-time me-1"></i> Salvando...');
        
        autoSaveTimer = setTimeout(function() {
          $('#submitBtn').html('<i class="bx bx-save me-1"></i> Salvar');
        }, 1000);
      });
    });
  </script>
  <script>
    // Previs√£o de vencimento na aba Produto
    function calcularPrevisaoVencimentoAnalise() {
      const dataInput = document.getElementById('id_data_pagamento');
      const parcelasInput = document.getElementById('id_numero_parcelas');
      const previsaoDiv = document.getElementById('vencimento-previsao-analise');
      if (!dataInput || !parcelasInput || !previsaoDiv) return;
      const diaEscolhido = parseInt(dataInput.value, 10);
      const parcelas = parseInt(parcelasInput.value, 10);
      if (isNaN(diaEscolhido) || isNaN(parcelas) || parcelas < 1) {
        previsaoDiv.textContent = '';
        return;
      }
      const hoje = new Date();
      let ano = hoje.getFullYear();
      let mes = hoje.getMonth() + 1; // 1-based
      let melhorData = null;
      let maiorDiferenca = -1;
      // Verifica at√© 3 meses √† frente
      for (let i = 0; i < 3; i++) {
        let novoMes = mes + i;
        let novoAno = ano + Math.floor((novoMes - 1) / 12);
        novoMes = ((novoMes - 1) % 12) + 1;
        let ultimoDiaMes = new Date(novoAno, novoMes, 0).getDate();
        let diaReal = Math.min(diaEscolhido, ultimoDiaMes);
        let dataCandidata = new Date(novoAno, novoMes - 1, diaReal);
        let diasAteParcela = Math.round((dataCandidata - hoje) / (1000 * 60 * 60 * 24));
        if (diasAteParcela > 0 && diasAteParcela <= 40) {
          if (diasAteParcela > maiorDiferenca) {
            melhorData = dataCandidata;
            maiorDiferenca = diasAteParcela;
          }
        }
      }
      if (melhorData) {
        const diaStr = melhorData.getDate().toString().padStart(2, '0');
        const mesStr = (melhorData.getMonth() + 1).toString().padStart(2, '0');
        const anoStr = melhorData.getFullYear();
        previsaoDiv.textContent = 'Primeiro vencimento: ' + diaStr + '/' + mesStr + '/' + anoStr;
      } else {
        previsaoDiv.textContent = 'N√£o h√° data de vencimento poss√≠vel.';
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      const dataInput = document.getElementById('id_data_pagamento');
      const parcelasInput = document.getElementById('id_numero_parcelas');
      if (dataInput && parcelasInput) {
        dataInput.addEventListener('change', calcularPrevisaoVencimentoAnalise);
        parcelasInput.addEventListener('change', calcularPrevisaoVencimentoAnalise);
        calcularPrevisaoVencimentoAnalise();
      }
    });
  </script>

{% endblock extra_scripts %}