{% extends "base.html" %}
{% load static iam_tags %}
{% load static %}
{% block title %}
{% if loja.pk %}Editar Loja{% else %}Criar Loja{% endif %}
{% endblock title %}

{% block content %}
{% load l10n %}
<div class="container-xxl mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">{% if loja.pk %}Editar Loja{% else %}Criar Loja{% endif %}</h4>
        </div>
        <div class="card-body">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
          
          {% if form.errors %}
            <div class="alert alert-danger" role="alert">
              <h6>Por favor, corrija os seguintes erros:</h6>
              <ul class="mb-0">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_nome" class="form-label">Nome</label>
                <input type="text" class="form-control" id="id_nome" name="nome" value="{{ form.nome.value|default_if_none:'' }}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_cnpj" class="form-label">CNPJ</label>
                <input type="text" class="form-control" id="id_cnpj" name="cnpj" value="{{ form.cnpj.value|default_if_none:'' }}">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_inscricao_estadual" class="form-label">Inscrição Estadual</label>
                <input type="text" class="form-control" id="id_inscricao_estadual" name="inscricao_estadual" value="{{ form.inscricao_estadual.value|default_if_none:'' }}">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_telefone" class="form-label">Telefone</label>
                <input type="text" class="form-control tel" id="id_telefone" name="telefone" value="{{ form.telefone.value|default_if_none:'' }}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_endereco" class="form-label">Endereço</label>
                <input type="text" class="form-control" id="id_endereco" name="endereco" value="{{ form.endereco.value|default_if_none:'' }}">
              </div>
            </div>
            <div class="row">
              {% localize on %}
              <div class="col-md-6 mb-3">
                <label for="id_meta_vendas_diaria" class="form-label">Meta de Vendas Diária</label>
                <input type="text" class="form-control money" id="id_meta_vendas_diaria" name="meta_vendas_diaria" value="{{ form.meta_vendas_diaria.value|default_if_none:'' }}">
              </div>
              {% endlocalize %}
              <div class="col-md-6 mb-3">
                <label for="id_meta_vendas_mensal" class="form-label">Meta de Vendas Mensal</label>
                <input type="text" class="form-control money" id="id_meta_vendas_mensal" name="meta_vendas_mensal" value="{{ form.meta_vendas_mensal.value|default_if_none:'' }}">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_entrada_caixa_diaria" class="form-label">Entrada de Caixa Diária</label>
                <input type="text" class="form-control money" id="id_entrada_caixa_diaria" name="entrada_caixa_diaria" value="{{ form.entrada_caixa_diaria.value|default_if_none:'' }}">
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_logo_loja" class="form-label">Logo da Loja</label>
                <input type="file" class="form-control" id="id_logo_loja" name="logo_loja">
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_email" class="form-label">Chave Pix</label>
                <input type="text" class="form-control" id="id_email" name="chave_pix" value="{{ form.chave_pix.value|default_if_none:'' }}">
              </div>
              <!-- Seção de Porcentagens de Desconto -->
              <div class="col-12 mb-4">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                      <i class="bx bx-percentage me-2"></i>
                      Porcentagens de Desconto por Parcelamento
                    </h5>
                    <small>Configure as porcentagens de desconto para cada modalidade de parcelamento</small>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_porcentagem_desconto_4" class="form-label fw-bold">
                          <span class="text-primary">4x Parcelas</span> <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="id_porcentagem_desconto_4"
                            name="porcentagem_desconto_4" step="0.01" min="0" max="100"
                            value="{{ form.porcentagem_desconto_4.value|default_if_none:'25.00' }}" required>
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="form-text text-muted">Porcentagem de desconto para parcelamento em 4 vezes</small>
                      </div>
                      
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_porcentagem_desconto_6" class="form-label fw-bold">
                          <span class="text-success">6x Parcelas</span> <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="id_porcentagem_desconto_6"
                            name="porcentagem_desconto_6" step="0.01" min="0" max="100"
                            value="{{ form.porcentagem_desconto_6.value|default_if_none:'25.00' }}" required>
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="form-text text-muted">Porcentagem de desconto para parcelamento em 6 vezes</small>
                      </div>
                      
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_porcentagem_desconto_8" class="form-label fw-bold">
                          <span class="text-warning">8x Parcelas</span> <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="id_porcentagem_desconto_8"
                            name="porcentagem_desconto_8" step="0.01" min="0" max="100"
                            value="{{ form.porcentagem_desconto_8.value|default_if_none:'25.00' }}" required>
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="form-text text-muted">Porcentagem de desconto para parcelamento em 8 vezes</small>
                      </div>
                      
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_porcentagem_desconto_10" class="form-label fw-bold">
                          <span class="text-info">10x Parcelas</span>
                        </label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="id_porcentagem_desconto_10"
                            name="porcentagem_desconto_10" step="0.01" min="0" max="100"
                            value="{{ form.porcentagem_desconto_10.value|default_if_none:'25.00' }}">
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="form-text text-muted">Porcentagem de desconto para parcelamento em 10 vezes</small>
                      </div>
                      
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_porcentagem_desconto_12" class="form-label fw-bold">
                          <span class="text-secondary">12x Parcelas</span>
                        </label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="id_porcentagem_desconto_12"
                            name="porcentagem_desconto_12" step="0.01" min="0" max="100"
                            value="{{ form.porcentagem_desconto_12.value|default_if_none:'25.00' }}">
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="form-text text-muted">Porcentagem de desconto para parcelamento em 12 vezes</small>
                      </div>
                      
                      <div class="col-md-6 col-lg-4 mb-3">
                        <label for="id_porcentagem_desconto_14" class="form-label fw-bold">
                          <span class="text-dark">14x Parcelas</span>
                        </label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="id_porcentagem_desconto_14"
                            name="porcentagem_desconto_14" step="0.01" min="0" max="100"
                            value="{{ form.porcentagem_desconto_14.value|default_if_none:'25.00' }}">
                          <span class="input-group-text">%</span>
                        </div>
                        <small class="form-text text-muted">Porcentagem de desconto para parcelamento em 14 vezes</small>
                      </div>
                    </div>
                    
                    <!-- Resumo das Porcentagens -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <div class="alert alert-info">
                          <h6 class="alert-heading">
                            <i class="bx bx-info-circle me-2"></i>
                            Resumo das Porcentagens Configuradas
                          </h6>
                          <div class="row" id="resumo-porcentagens">
                            <div class="col-md-2 text-center">
                              <div class="card border-primary h-100">
                                <div class="card-body p-2">
                                  <small class="text-muted">4x</small><br>
                                  <span class="fw-bold text-primary" id="resumo-4x">25%</span>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-2 text-center">
                              <div class="card border-success h-100">
                                <div class="card-body p-2">
                                  <small class="text-muted">6x</small><br>
                                  <span class="fw-bold text-success" id="resumo-6x">25%</span>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-2 text-center">
                              <div class="card border-warning h-100">
                                <div class="card-body p-2">
                                  <small class="text-muted">8x</small><br>
                                  <span class="fw-bold text-warning" id="resumo-8x">25%</span>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-2 text-center">
                              <div class="card border-info h-100">
                                <div class="card-body p-2">
                                  <small class="text-muted">10x</small><br>
                                  <span class="fw-bold text-info" id="resumo-10x">25%</span>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-2 text-center">
                              <div class="card border-secondary h-100">
                                <div class="card-body p-2">
                                  <small class="text-muted">12x</small><br>
                                  <span class="fw-bold text-secondary" id="resumo-12x">25%</span>
                                </div>
                              </div>
                            </div>
                            <div class="col-md-2 text-center">
                              <div class="card border-dark h-100">
                                <div class="card-body p-2">
                                  <small class="text-muted">14x</small><br>
                                  <span class="fw-bold text-dark" id="resumo-14x">25%</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_qr_code_aplicativo" class="form-label">Qr Code Aplicativo</label>
                <input type="file" class="form-control" id="id_qr_code_aplicativo" name="qr_code_aplicativo">
              </div>
              <div class="col-md-6 mb-3">
                <label for="id_codigo_aplicativo" class="form-label">Código Aplicativo</label>
                <input type="text" class="form-control" id="id_codigo_aplicativo" name="codigo_aplicativo" value="{{ form.codigo_aplicativo.value|default_if_none:'' }}">
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="id_credfacil" name="credfacil" {% if form.credfacil.value %}checked{% endif %}>
                  <label class="form-check-label" for="id_credfacil">
                    Credfacil
                  </label>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="id_mensagem_garantia" class="form-label">Mensagem de Garantia</label>
                <textarea class="form-control" id="id_mensagem_garantia" name="mensagem_garantia" rows="6">{{ form.mensagem_garantia.value|default_if_none:'' }}</textarea>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="editorjs" class="form-label">Contrato</label>
                <div class="border rounded p-3" style="max-height: 500px; overflow-y: auto;">
                  <div id="editorjs" ></div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="id_usuarios" class="form-label">Usuários</label>
                {{ form.usuarios }}
              </div>
            </div>
            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="id_grupos" class="form-label">Gerentes</label>
                {{ form.gerentes }}
              </div>
              {% if user|has_perm:"vendas.add_loja" or user|has_perm:"change_loja" %}
            <button type="submit" class="btn btn-primary">{% if loja.pk %}Salvar{% else %}Criar{% endif %}</button>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_scripts %}
{{ form.media.js}}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    $('.money').mask('000.000.000,00', { reverse: true });
    $('.tel').mask('00 00000-0000');
    
    // Função para atualizar resumo das porcentagens
    function updatePorcentagensResumo() {
        const porcentagens = ['4', '6', '8', '10', '12', '14'];
        porcentagens.forEach(parc => {
            const campo = document.getElementById(`id_porcentagem_desconto_${parc}`);
            const resumo = document.getElementById(`resumo-${parc}x`);
            if (campo && resumo) {
                const valor = campo.value || '25.00';
                resumo.textContent = valor + '%';
            }
        });
    }
    
    // Adicionar event listeners para os campos de porcentagem
    document.addEventListener('DOMContentLoaded', function() {
        const porcentagens = ['4', '6', '8', '10', '12', '14'];
        porcentagens.forEach(parc => {
            const campo = document.getElementById(`id_porcentagem_desconto_${parc}`);
            if (campo) {
                campo.addEventListener('input', updatePorcentagensResumo);
                campo.addEventListener('blur', updatePorcentagensResumo);
            }
        });
        
        // Inicializar resumo
        updatePorcentagensResumo();
    });
    
    $('form').submit(function () {
      $('.money').each(function () {
        var rawValue = $(this).cleanVal();
        if (rawValue === "") return; // se estiver vazio, pula
        // Converte para número considerando os dois últimos dígitos como decimais
        var numericValue = parseInt(rawValue, 10) / 100;
        // Garante duas casas decimais no valor final
        $(this).val(numericValue.toFixed(2));
      });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@2"></script>

<script data-contrato="{{ form.contrato.value }}">
document.addEventListener('DOMContentLoaded', function() {
  // Seleciona o elemento <script>
  const scriptElement = document.querySelector('script[data-contrato]');
  
  // Obtém o valor do atributo 'data-contrato'
  const contratoValue = scriptElement.getAttribute('data-contrato');
  
  // Verifica se o contrato tem valor válido, senão usa um objeto vazio
  let contratoData = {};
  try {
    if (contratoValue && contratoValue !== 'None' && contratoValue !== 'null') {
      contratoData = JSON.parse(contratoValue);
    }
  } catch (e) {
    console.warn('Erro ao fazer parse do contrato:', e);
    contratoData = {};
  }

  const editor = new EditorJS({ 
    holder: 'editorjs', 
    tools: { 
      header: Header, 
      list: {
        class: EditorjsList,
        inlineToolbar: true,
        config: {
          defaultStyle: 'unordered'
        },
      },
    }, 
    data: contratoData,
    placeholder: 'Escreva seu contrato aqui...',
    onChange: (api, event) => {
      console.log('Now I know that Editor\'s content changed!', event)

    },
    i18n: {
      messages: {
        ui: {
          "blockTunes": {
            "toggler": {
              'Click to tune': 'Clique para ajustar',
            },
          },
          "inlineToolbar": {
            "converter": {
              'Convert to': 'Converter para',
            },
          },
          "toolbar": {
            "toolbox": {
              "Add": 'Adicionar',
            },
          },
        },
        toolNames: {
          "Text": 'Texto',
          "Heading": 'Título',
          "Unordered List": 'Lista não ordenada',
          "Ordered List": 'Lista ordenada',
          "CheckList": 'Checklist',
        },
        tools: {
          "list": {
            "unordered": 'Lista não ordenada',
            "ordered": 'Lista ordenada',
          },
        },
      },
    }
  })

  const form = document.querySelector('form')
  form.addEventListener('submit', async (event) => {
    event.preventDefault()
    const outputData = await editor.save()
    const outputDataString = JSON.stringify(outputData)
    const input = document.createElement('input')
    input.type = 'hidden'
    input.name = 'contrato'
    input.value = outputDataString
    form.appendChild(input)
    form.submit()
  })
})
</script>
{% endblock %}